name: Create Notes Routine (Dynamic Branch Discovery)

on:
  # schedule:
  #   - cron: "*/15 * * * *" # Runs every 15 minutes
  workflow_dispatch:

jobs:
  discover-branches:
    runs-on: ubuntu-latest
    outputs:
      branches: ${{ steps.branch-list.outputs.branches }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get all branches
        id: branch-list
        run: |
          # Get all remote branches
          git branch -r | grep -E "(origin/main|origin/staging/)" | sed 's/origin\///' > branches.txt

          # Convert to JSON array format for matrix
          echo "branches=$(cat branches.txt | jq -R -s -c 'split("\n")[:-1]')" >> $GITHUB_OUTPUT

          # Debug output
          echo "Found branches:"
          cat branches.txt
          echo "JSON output: ${{ steps.branch-list.outputs.branches }}"

  fetch-and-submit:
    needs: discover-branches
    runs-on: ubuntu-latest
    timeout-minutes: 25
    strategy:
      matrix:
        branch: ${{ fromJson(needs.discover-branches.outputs.branches) }}
    env:
      # X API OAuth 1.0a credentials
      X_API_KEY: ${{ secrets.X_API_KEY }}
      X_API_KEY_SECRET: ${{ secrets.X_API_KEY_SECRET }}
      X_ACCESS_TOKEN: ${{ secrets.X_ACCESS_TOKEN }}
      X_ACCESS_TOKEN_SECRET: ${{ secrets.X_ACCESS_TOKEN_SECRET }}
      # X API Bearer Token for note evaluation
      X_BEARER_TOKEN: ${{ secrets.X_BEARER_TOKEN }}
      # OpenRouter API key for AI models
      OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
      # Airtable credentials for logging
      AIRTABLE_BASE_ID: ${{ secrets.AIRTABLE_BASE_ID }}
      AIRTABLE_API_KEY: ${{ secrets.AIRTABLE_API_KEY }}
      AIRTABLE_TABLE_NAME: ${{ secrets.AIRTABLE_TABLE_NAME }}
    steps:
      - name: Checkout specific branch
        uses: actions/checkout@v4
        with:
          ref: ${{ matrix.branch }}

      - uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install

      - name: Install Playwright Browsers
        run: npx playwright install --with-deps

      - name: Run create notes routine script
        run: bun run src/scripts/createNotesRoutine.ts
        env:
          GITHUB_BRANCH_NAME: ${{ matrix.branch }}
